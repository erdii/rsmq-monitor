<!DOCTYPE html><html lang="en"><head><title>_src/lib/influx-connector</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="_src/lib/influx-connector"><meta name="groc-project-path" content="_src/lib/influx-connector.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">_src/lib/influx-connector.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">{ log, logErr, debug } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./logger"</span>)(<span class="hljs-string">"rsmq-monitor:lib:influx-connector"</span>)
_ = <span class="hljs-built_in">require</span> <span class="hljs-string">"lodash"</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">"./config"</span>
errors = <span class="hljs-built_in">require</span> <span class="hljs-string">"./errors"</span>
influx = <span class="hljs-built_in">require</span> <span class="hljs-string">"influx"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RMInfluxConnector</span></span>
	<span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>build a dictionary with relation [key:qname] from queues-config</p></div></div><div class="code"><div class="wrapper">		queues = config.get <span class="hljs-string">"queues"</span>
		<span class="hljs-property">@_queues</span> = {}
		<span class="hljs-property">@_queues</span>[queue.key] = queue.qname <span class="hljs-keyword">for</span> queue <span class="hljs-keyword">in</span> queues</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connect to the InfluxDB server</p></div></div><div class="code"><div class="wrapper">		options = config.get <span class="hljs-string">"influx"</span>
		debug <span class="hljs-string">"InfluxDB options"</span>, options
		<span class="hljs-property">@client</span> = influx options
		<span class="hljs-keyword">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>writeStats(<code>data</code>, cb)
<em>object</em> <code>data</code>: {
  <code>key</code>: [
    <em>object</em> <code>sample</code>,
    ...
  ],
  ...</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-comment"># </span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>data</code> contains either an array of <code>samples</code> or a single <code>sample</code> for each queue (identified by <code>key</code>) for which you want to send <code>samples</code>:</li>
<li><code>key</code>: the queue&#39;s key - as defined in config.json</li>
<li><em>array</em> <code>sample</code><ul>
<li><code>sample</code>: an object in the following form:<ul>
<li><code>time</code>: the unix timestamp that defines the measurement time</li>
<li><code>count</code>: the number of messages currently in the queue</li>
<li><code>sent</code>: total number of messages ever sent to the queue</li>
<li><code>recv</code>: total number of messages ever received by workers</li>
</ul>
</li>
</ul>
</li>
</ul></div></div><div class="code"><div class="wrapper">	<span class="hljs-attribute">writeStats</span>: <span class="hljs-function"><span class="hljs-params">(data, cb)</span> =&gt;</span>
		<span class="hljs-keyword">for</span> key, measurement <span class="hljs-keyword">of</span> data
			<span class="hljs-keyword">if</span> _.isArray(measurement)
				<span class="hljs-keyword">for</span> sample, i <span class="hljs-keyword">in</span> measurement
					measurement[i] = [sample]
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> _.isObject(measurement)
				data[key] = [[measurement]]
			<span class="hljs-keyword">else</span>
				<span class="hljs-keyword">throw</span> errors.create <span class="hljs-string">"ETYPE"</span>,
					<span class="hljs-attribute">identifier</span>: <span class="hljs-string">"data.<span class="hljs-subst">#{key}</span>"</span>
					<span class="hljs-attribute">expected</span>: <span class="hljs-string">"array of objects or object"</span>

		debug <span class="hljs-string">"writing stats to influx..."</span>
		<span class="hljs-property">@client</span>.writeSeries data, {<span class="hljs-attribute">precision</span>:<span class="hljs-string">'s'</span>}, <span class="hljs-function"><span class="hljs-params">(err, resp)</span> -&gt;</span>
			<span class="hljs-keyword">if</span> err?
				logErr err
				cb(err)
				<span class="hljs-keyword">return</span>
			debug <span class="hljs-string">"success!"</span>
			cb()
			<span class="hljs-keyword">return</span>
		<span class="hljs-keyword">return</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> RMInfluxConnector()</div></div></div></div></body></html>